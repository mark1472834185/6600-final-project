---
title: "data preprocess for project"
author: "Group Seattle OG"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
```

```{r}
# read the csv file
data <- read_csv("www/data/Data.csv")
```

```{r}
# see some info
head(data)
str(data)
```

```{r}
# change columns names
colnames(data)[5:length(colnames(data))] <- seq(1995,2018)
```

```{r}
# change column data type
data[,5:28] <- sapply(data[,5:28], as.numeric )
str(data)
```

```{r}
# melt the dataset
data <- gather(data,key = "Year",value = "Value",-`Country Name`,-`Country Code`,-`Series Name`,-`Series Code`)
```

```{r}
# replace NA to 0
data$Value[is.na(data$Value)] <- 0
```

```{r}
# remove the "(constant 2018 US$)" in Series Name
data$`Series Name` <- gsub(" \\(constant 2018 US\\$\\)","",data$`Series Name`)
```

```{r}
# test regex pattern
a <- "Human capital (constant 2018 US$)"
a <- gsub(" \\(constant 2018 US\\$\\)","",a)
print(a)
```

# K mean

```{r}
# remove Series Code columns
data <- data %>% select(-`Series Code`)
```

```{r}
# 
data <- data %>% pivot_wider(names_from = `Series Name`,values_from = Value)
```

```{r}
# filter the data to 2018 in order to do custering
data_2018 <- data %>% filter(Year==1995)
```

```{r}
# remove label cols
data_2018_numeric <- data_2018[,4:55] %>% scale()
```

```{r}
pca_data <- prcomp(data_2018_numeric, scale. = TRUE)

# Determine the number of principal components to retain
eigenvalues <- (pca_data$sdev)^2
plot(eigenvalues, type = "b", main = "Scree Plot", xlab = "Principal Component", ylab = "Eigenvalue")
num_pcs <- 5

# Transform the data using the selected principal components
pca_transformed_data <- predict(pca_data, newdata = data_2018_numeric)[, 1:num_pcs]

# Perform k-means clustering on the transformed data
k <- 4
kmeans_result <- kmeans(pca_transformed_data, centers = k)

# View the cluster assignments
print(kmeans_result$cluster)

# View the cluster centers
print(kmeans_result$centers)

# View the total within-cluster sum of squares
print(kmeans_result$tot.withinss)


print(length(kmeans_result$cluster))

data_clustered <- cbind(data_2018, cluster = kmeans_result$cluster)



```

```{r}

print(data_clustered[,c(1,56)] %>% filter(cluster == 1))
print(data_clustered[,c(1,56)] %>% filter(cluster == 2))
print(data_clustered[,c(1,56)] %>% filter(cluster == 3))
print(data_clustered[,c(1,56)] %>% filter(cluster == 4))
```

```{r}
# def kmeans func with dataframe, n-clusters and the Year we want to cluster
# return a dataframe with clusters label

km <- function(df,year,k){
  # filter the data by year
  df <- df %>% filter(Year==year)
  
  # remove label cols and scale it
  df_numeric <- df[,4:55] %>% scale()
  
  # dimensionality reuction(PCA)
  df_pca <- prcomp(df_numeric, scale. = TRUE)
  
  # Transform the data using the selected principal components
  # Since we have know the approprate number, we set it to 5
  num_pcs <- 5
  pca_transformed_data <- predict(df_pca, newdata = df_numeric)[, 1:num_pcs]
  
  # Perform k-means clustering on the transformed data
  kmeans_result <- kmeans(pca_transformed_data, centers = k)
  
  # commbine original df and cluster label
  df_clustered <- cbind(df, cluster = kmeans_result$cluster)
  
  return(df_clustered)
  
}
```
